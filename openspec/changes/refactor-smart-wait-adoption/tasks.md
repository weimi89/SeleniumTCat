# Implementation Tasks

**⚠️ 重要原則：每次修改後立即測試，採用增量式開發**

## 1. 準備階段
- [x] 1.1 建立測試資料集和測試帳號（至少 1 個可用帳號）✅ accounts_baseline_test.json
- [x] 1.2 記錄當前執行時間基準（單一帳號測試）✅ baseline-test-record.md
- [x] 1.3 建立 feature 分支：`git checkout -b feature/smart-wait-adoption` ✅
- [x] 1.4 確認當前版本可正常執行（baseline test）✅

---

## 2. BaseScraper 登入流程優化（Phase 1）✅ **已完成**

### 2.1 替換登入後 URL 變化等待 ✅
- [x] 2.1.1 **修改** `base_scraper.py:290` - 將 `time.sleep(2)` 替換為 `self.smart_wait_for_element()` ✅ Commit: 58c4003
- [x] 2.1.2 **測試** - 執行單一帳號登入測試 ✅
- [x] 2.1.3 **驗證** - 確認登入成功且 URL 正確跳轉 ✅
- [x] 2.1.4 **記錄** - 若有問題立即回滾，記錄錯誤原因 ✅

### 2.2 替換表單提交等待 ✅
- [x] 2.2.1 **修改** `base_scraper.py:292` - 將 `time.sleep(5)` 替換為 `smart_wait_for_url_change()` ✅ Commit: 14ef157
- [x] 2.2.2 **測試** - 執行單一帳號登入測試（重複 2.1.2）✅
- [x] 2.2.3 **驗證** - 確認表單提交和後續處理正常 ✅
- [x] 2.2.4 **Commit** - `git commit -m "重構: BaseScraper 登入流程採用智慧等待"` ✅
- [x] 2.2.5 **文檔** - 建立 phase-1-completion.md ✅

---

## 3. PaymentScraper 導航優化（Phase 2）✅ **已完成**

### 3.1 替換導航重試間隔 ✅
- [x] 3.1.1 **修改** `payment_scraper.py:58` - 移除固定等待 `time.sleep(3)` ✅ Commit: b23bca7
- [x] 3.1.2 **測試** - 執行客樂得對帳單下載（1 期）✅
- [x] 3.1.3 **驗證** - 確認導航到查詢頁面成功 ✅
- [x] 3.1.4 **記錄** - 檢查是否有導航失敗的情況 ✅

### 3.2 替換 JavaScript 連結點擊等待 ✅
- [x] 3.2.1 **修改** `payment_scraper.py:350` - 替換 `time.sleep(5)` 為 `smart_wait_for_url_change()` ✅
- [x] 3.2.2 **測試** - 執行客樂得對帳單下載（1 期）✅
- [x] 3.2.3 **驗證** - 確認點擊後頁面正確載入 ✅
- [x] 3.2.4 **修改** `payment_scraper.py:386` - 同樣替換處理 ✅
- [x] 3.2.5 **測試** - 重複測試確認兩處都正常 ✅
- [x] 3.2.6 **Commit** - `git commit -m "重構: PaymentScraper JavaScript 連結點擊採用智慧等待"` ✅ Commit: e9902ca

### 3.3 替換直接 URL 訪問等待 ✅
- [x] 3.3.1 **修改** `payment_scraper.py:468-473` - 替換頁面載入等待為 `smart_wait()` + document.readyState ✅
- [x] 3.3.2 **測試** - 執行客樂得對帳單下載（1 期）✅
- [x] 3.3.3 **驗證** - 確認 URL 訪問和 alert 處理正常 ✅
- [x] 3.3.4 **Commit** - `git commit -m "重構: PaymentScraper 直接 URL 訪問採用智慧等待頁面載入"` ✅ Commit: c689a30

### 3.4 替換重新初始化和結算期間頁面載入 ✅
- [x] 3.4.1 **修改** `payment_scraper.py:661` - 重新初始化頁面載入採用智慧等待 ✅ Commit: 14cf2ed
- [x] 3.4.2 **修改** `payment_scraper.py:726` - 結算期間頁面採用智慧等待 ✅ Commit: 2c16591
- [x] 3.4.3 **測試** - 執行客樂得對帳單下載（1 期）✅
- [x] 3.4.4 **驗證** - 確認能正確選擇和處理多期資料 ✅

### 3.5 替換 AJAX 載入等待 ✅
- [x] 3.5.1 **修改** `payment_scraper.py:1069-1078` - 替換為 `smart_wait_for_element()` 等待下載按鈕 ✅ Commit: 616fd1d
- [x] 3.5.2 **測試** - 執行完整的客樂得對帳單下載（1 期）✅
- [x] 3.5.3 **驗證** - 確認 AJAX 載入和下載按鈕尋找正常 ✅
- [x] 3.5.4 **驗證** - 檢查下載的 Excel 檔案完整性 ✅
- [x] 3.5.5 **Commit** - `git commit -m "重構: PaymentScraper AJAX 採用智慧等待"` ✅
- [x] 3.5.6 **修復** - 修復參數名稱錯誤 (message → error_message) ✅ Commit: c29b103

### 3.6 完整功能驗證 ✅
- [x] 3.6.1 **測試** - 執行完整流程（1 期下載）✅
- [x] 3.6.2 **驗證** - 確認所有功能正常，檔案完整 ✅ 下載成功：客樂得對帳單_8341748006_20251006-20251008.xlsx
- [x] 3.6.3 **記錄** - 記錄執行時間，與基準比較 ✅ 從 27秒 降至 15秒 (44% 提升)
- [x] 3.6.4 **文檔** - 建立 phase-2-completion.md ✅

---

## 4. FreightScraper 優化（Phase 3）✅ **已完成**

### 4.1 替換導航間隔 ✅
- [x] 4.1.1 **修改** `freight_scraper.py:74` - 優化導航邏輯 ✅ Commit: a9caceb
- [x] 4.1.2 **測試** - 執行運費查詢下載（單一日期範圍）✅
- [x] 4.1.3 **驗證** - 確認導航成功 ✅

### 4.2 替換直接 URL 等待 ✅
- [x] 4.2.1 **修改** `freight_scraper.py:178, 188` - 替換為智慧等待 ✅ Commit: d564809
- [x] 4.2.2 **測試** - 執行運費查詢下載（完整）✅
- [x] 4.2.3 **驗證** - 確認 AJAX 搜尋和下載正常 ✅
- [x] 4.2.4 **Commit** - `git commit -m "重構: FreightScraper 採用智慧等待"` ✅

### 4.3 完整功能驗證 ✅
- [x] 4.3.1 **測試** - 執行完整運費查詢流程 ✅ 9月份資料測試，6個帳號成功下載
- [x] 4.3.2 **驗證** - 檢查下載檔案正確性 ✅ 檔案命名正確，執行時長約 0.25-0.31 分鐘
- [x] 4.3.3 **文檔** - 建立 phase-3-completion.md ✅

---

## 5. UnpaidScraper 優化（Phase 4）✅ **已完成**

### 5.1 替換導航間隔 ✅
- [x] 5.1.1 **修改** `unpaid_scraper.py:54` - 優化導航邏輯 ✅
- [x] 5.1.2 **測試** - 執行交易明細表下載（1 週期）✅
- [x] 5.1.3 **驗證** - 確認導航成功 ✅

### 5.2 替換 alert 等待 ✅
- [x] 5.2.1 **修改** `unpaid_scraper.py:158, 168` - 改善 alert 檢測和頁面載入 ✅
- [x] 5.2.2 **測試** - 執行交易明細表下載 ✅
- [x] 5.2.3 **驗證** - 確認 alert 處理正常 ✅

### 5.3 替換重試等待 ✅
- [x] 5.3.1 **修改** `unpaid_scraper.py:180, 195, 211` - 替換為智慧等待 ✅
- [x] 5.3.2 **測試** - 執行交易明細表下載（1 週期）✅
- [x] 5.3.3 **驗證** - 確認處理正常 ✅
- [x] 5.3.4 **Commit** - `git commit -m "重構: UnpaidScraper 採用智慧等待"` ✅ Commit: 95207ab

### 5.4 完整功能驗證 ✅
- [x] 5.4.1 **測試** - 執行完整交易明細表下載 ✅ 8個帳號測試成功
- [x] 5.4.2 **驗證** - 檢查所有週期檔案正確 ✅ 檔案命名正確，執行時長約 0.23-0.31 分鐘
- [x] 5.4.3 **文檔** - 建立 phase-4-completion.md ✅

---

## 6. MultiAccountManager 檢視
- [ ] 6.1 **檢視** `multi_account_manager.py:124` 帳號間隔等待
- [ ] 6.2 **決定** - 保留此處 `time.sleep(3)`（避免請求過於頻繁）
- [ ] 6.3 **添加註解** - 說明保留原因

---

## 7. 多帳號整合測試（Phase 5）

### 7.1 準備測試
- [ ] 7.1.1 準備 2-3 個測試帳號
- [ ] 7.1.2 確保 accounts.json 配置正確

### 7.2 逐一測試各功能
- [ ] 7.2.1 **測試** - 客樂得對帳單（2 個帳號，各 2 期）
- [ ] 7.2.2 **驗證** - 所有帳號成功，檔案完整
- [ ] 7.2.3 **測試** - 運費查詢（2 個帳號）
- [ ] 7.2.4 **驗證** - 所有帳號成功
- [ ] 7.2.5 **測試** - 交易明細表（2 個帳號，各 2 週期）
- [ ] 7.2.6 **驗證** - 所有帳號成功

### 7.3 邊界情況測試
- [ ] 7.3.1 **測試** - 網路延遲情境（如果可能）
- [ ] 7.3.2 **測試** - 無資料情況處理
- [ ] 7.3.3 **測試** - 登入失敗重試機制

---

## 8. 效能驗證與記錄

### 8.1 效能測試
- [ ] 8.1.1 **記錄** - 優化後執行時間（相同測試集）
- [ ] 8.1.2 **計算** - 時間節省百分比
- [ ] 8.1.3 **驗證** - 確認達到 40-60% 提升目標
- [ ] 8.1.4 **記錄** - 產生效能報告

### 8.2 品質檢查
- [ ] 8.2.1 **檢查** - 無任何功能退化
- [ ] 8.2.2 **檢查** - 錯誤處理仍然正常
- [ ] 8.2.3 **檢查** - 檔案完整性 100%

---

## 9. 文檔更新
- [ ] 9.1 更新 CLAUDE.md 記錄此次優化成果
- [ ] 9.2 更新 README.md 效能相關說明
- [ ] 9.3 添加智慧等待使用最佳實踐文檔

---

## 10. 最終整理與提交

### 10.1 代碼清理
- [ ] 10.1.1 移除所有 debug 訊息
- [ ] 10.1.2 確認無遺留的 TODO 註解
- [ ] 10.1.3 執行代碼格式化

### 10.2 最終驗證
- [ ] 10.2.1 **完整測試** - 執行所有 3 種功能的多帳號測試
- [ ] 10.2.2 **效能確認** - 最終效能提升達標
- [ ] 10.2.3 **功能確認** - 無任何功能損失

### 10.3 提交與歸檔
- [ ] 10.3.1 合併所有 commits：`git rebase -i main`
- [ ] 10.3.2 建立 PR 或合併到 main
- [ ] 10.3.3 執行 `openspec archive refactor-smart-wait-adoption`
- [ ] 10.3.4 更新 specs/ 目錄（由 openspec 自動處理）

---

## 🔄 如果發現問題

**立即處理流程**：
1. **記錄錯誤** - 詳細記錄錯誤訊息和情況
2. **回滾修改** - `git checkout -- <檔案>` 或 `git revert <commit>`
3. **分析原因** - 理解為什麼智慧等待不適用
4. **調整策略** - 可能需要調整超時時間或等待條件
5. **重新測試** - 修正後再次測試
6. **繼續下一步** - 確認正常後繼續下一個任務

**測試失敗不繼續** - 每個階段都必須通過測試才能進入下一階段！
